<template>
  <textarea></textarea>
</template>

<script>
  import CodeMirror from 'CodeMirror'

  export default {
    data: {
      value: '',
      mode: 'html',
      theme: null
    },
    onrender() {
      const editor = this.editor = CodeMirror.fromTextArea(this.find('textarea'))

      let updating = false

      editor.on('change', () => {
        if (updating) return
        updating = true
        this.set('value', editor.getValue())
        updating = false
      })

      this.observe('*', (val, old, kp) => {

        if (kp === 'value') {
          if (updating) return
          updating = true
          if (!val && typeof (val) !== 'string') val = ''
          editor.setValue(val)
          updating = false
          return
        }

        if (Ractive.DEBUG) console.log(kp + ': ' + old + ' -> ' + val)

        if (kp === 'mode') {
          if (val === 'html') val = 'htmlmixed'
          if (val === 'json') val = { name: 'javascript', json: true }
        }
        editor.setOption(kp, val)
      })
    },
    onteardown() {
      this.editor.toTextArea()
    }
  }

</script>
